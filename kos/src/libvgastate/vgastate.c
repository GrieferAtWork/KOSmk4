/*[[[magic
// Optimize this file for size
local opt = options.setdefault("GCC.options", []);
opt.removeif([](e) -> e.startswith("-O"));
//opt.append("-Os");
]]]*/
/* Copyright (c) 2019-2021 Griefer@Work                                       *
 *                                                                            *
 * This software is provided 'as-is', without any express or implied          *
 * warranty. In no event will the authors be held liable for any damages      *
 * arising from the use of this software.                                     *
 *                                                                            *
 * Permission is granted to anyone to use this software for any purpose,      *
 * including commercial applications, and to alter it and redistribute it     *
 * freely, subject to the following restrictions:                             *
 *                                                                            *
 * 1. The origin of this software must not be misrepresented; you must not    *
 *    claim that you wrote the original software. If you use this software    *
 *    in a product, an acknowledgement (see the following) in the product     *
 *    documentation is required:                                              *
 *    Portions Copyright (c) 2019-2021 Griefer@Work                           *
 * 2. Altered source versions must be plainly marked as such, and must not be *
 *    misrepresented as being the original software.                          *
 * 3. This notice may not be removed or altered from any source distribution. *
 */
#ifndef GUARD_LIBVGASTATE_VGASTATE_C
#define GUARD_LIBVGASTATE_VGASTATE_C 1
#define _KOS_SOURCE 1
#define _LARGEFILE64_SOURCE 1
#define _KOS_ALTERATIONS_SOURCE 1 /* for pread64/pwrite64 with pos64_t */

#include "api.h"
/**/

#include <hybrid/align.h>
#include <hybrid/atomic.h>

#include <kos/kernel/types.h>
#include <kos/types.h>
#include <sys/io.h>

#include <string.h>
#include <strings.h>

#include <libphys/phys.h>
#include <libvgastate/vga.h>
#include <libvm86/emulator.h>

#include "vgaio.h"
#include "vgastate.h"

#ifdef __KERNEL__
#include <debugger/rt.h>
#include <kernel/memory.h>
#include <kernel/mman.h>      /* mman_kernel */
#include <kernel/mman/kram.h> /* mman_unmap_kram_and_kfree */
#include <kernel/mman/map.h>  /* mman_map */
#include <kernel/paging.h>
#else /* __KERNEL__ */
#include <sys/mman.h>

#include <fcntl.h>
#include <malloc.h>
#include <unistd.h>
#endif /* !__KERNEL__ */


DECL_BEGIN

#define obzero(obj) bzero(&(obj), sizeof(obj))

PRIVATE WUNUSED NONNULL((1)) unsigned int
NOTHROW_KERNEL(CC save_vga_mode)(struct vga_mode *__restrict self) {
	unsigned int i;
	vga_r(VGA_IS1_RC), vga_w(VGA_ATT_W, 0x00);
	self->vm_att_mode         = vga_rattr(VGA_ATC_MODE);
	self->vm_att_overscan     = vga_rattr(VGA_ATC_OVERSCAN);
	self->vm_att_plane_enable = vga_rattr(VGA_ATC_PLANE_ENABLE);
	self->vm_att_pel          = vga_rattr(VGA_ATC_PEL);
	self->vm_att_color_page   = vga_rattr(VGA_ATC_COLOR_PAGE);
	for (i = 0; i < 16; ++i) {
		self->vm_att_pal[i] = vga_rattr(VGA_ATC_PALETTE0 + i);
	}
	vga_r(VGA_IS1_RC), vga_w(VGA_ATT_W, 0x20);
	self->vm_mis               = vga_r(VGA_MIS_R);
	self->vm_gfx_sr_value      = vga_rgfx(VGA_GFX_SR_VALUE);
	self->vm_gfx_sr_enable     = vga_rgfx(VGA_GFX_SR_ENABLE);
	self->vm_gfx_compare_value = vga_rgfx(VGA_GFX_COMPARE_VALUE);
	self->vm_gfx_data_rotate   = vga_rgfx(VGA_GFX_DATA_ROTATE);
	self->vm_gfx_plane_read    = vga_rgfx(VGA_GFX_PLANE_READ);
	self->vm_gfx_mode          = vga_rgfx(VGA_GFX_MODE);
	self->vm_gfx_misc          = vga_rgfx(VGA_GFX_MISC);
	self->vm_gfx_compare_mask  = vga_rgfx(VGA_GFX_COMPARE_MASK);
	self->vm_gfx_bit_mask      = vga_rgfx(VGA_GFX_BIT_MASK);
	self->vm_crt_h_total       = vga_rcrt(VGA_CRTC_H_TOTAL);
	self->vm_crt_h_disp        = vga_rcrt(VGA_CRTC_H_DISP);
	self->vm_crt_h_blank_start = vga_rcrt(VGA_CRTC_H_BLANK_START);
	self->vm_crt_h_blank_end   = vga_rcrt(VGA_CRTC_H_BLANK_END);
	self->vm_crt_h_sync_start  = vga_rcrt(VGA_CRTC_H_SYNC_START);
	self->vm_crt_h_sync_end    = vga_rcrt(VGA_CRTC_H_SYNC_END);
	self->vm_crt_v_total       = vga_rcrt(VGA_CRTC_V_TOTAL);
	self->vm_crt_overflow      = vga_rcrt(VGA_CRTC_OVERFLOW);
	self->vm_crt_preset_row    = vga_rcrt(VGA_CRTC_PRESET_ROW);
	self->vm_crt_max_scan      = vga_rcrt(VGA_CRTC_MAX_SCAN);
	self->vm_crt_cursor_start  = vga_rcrt(VGA_CRTC_CURSOR_START);
	self->vm_crt_cursor_end    = vga_rcrt(VGA_CRTC_CURSOR_END);
	self->vm_crt_start_hi      = vga_rcrt(VGA_CRTC_START_HI);
	self->vm_crt_start_lo      = vga_rcrt(VGA_CRTC_START_LO);
	self->vm_crt_cursor_hi     = vga_rcrt(VGA_CRTC_CURSOR_HI);
	self->vm_crt_cursor_lo     = vga_rcrt(VGA_CRTC_CURSOR_LO);
	self->vm_crt_v_sync_start  = vga_rcrt(VGA_CRTC_V_SYNC_START);
	self->vm_crt_v_sync_end    = vga_rcrt(VGA_CRTC_V_SYNC_END);
	self->vm_crt_v_disp_end    = vga_rcrt(VGA_CRTC_V_DISP_END);
	self->vm_crt_offset        = vga_rcrt(VGA_CRTC_OFFSET);
	self->vm_crt_underline     = vga_rcrt(VGA_CRTC_UNDERLINE);
	self->vm_crt_v_blank_start = vga_rcrt(VGA_CRTC_V_BLANK_START);
	self->vm_crt_v_blank_end   = vga_rcrt(VGA_CRTC_V_BLANK_END);
	self->vm_crt_mode          = vga_rcrt(VGA_CRTC_MODE);
	self->vm_crt_line_compare  = vga_rcrt(VGA_CRTC_LINE_COMPARE);
	self->vm_seq_plane_write   = vga_rseq(VGA_SEQ_PLANE_WRITE);
	self->vm_seq_character_map = vga_rseq(VGA_SEQ_CHARACTER_MAP);
	self->vm_seq_memory_mode   = vga_rseq(VGA_SEQ_MEMORY_MODE);
	self->vm_seq_clock_mode    = vga_rseq(VGA_SEQ_CLOCK_MODE);
	return VGA_STATE_ERROR_SUCCESS;
}

PRIVATE WUNUSED NONNULL((1)) unsigned int
NOTHROW_KERNEL(CC load_vga_mode)(struct vga_mode const *__restrict self,
                                 u8 resmask) {
	unsigned int i;

	/* Turn off the screen. */
	{
		u8 qr1 = vga_rseq(VGA_SEQ_CLOCK_MODE);
		vga_wseq(VGA_SEQ_RESET, 0x1);
		vga_wseq(VGA_SEQ_CLOCK_MODE, qr1 | VGA_SR01_FSCREEN_OFF);
		vga_wseq(VGA_SEQ_RESET, 0x3);
	}

	/* Enable graphics mode. */
	vga_r(VGA_IS1_RC), vga_w(VGA_ATT_W, 0x00);
	vga_wattr_res(VGA_ATC_MODE, self->vm_att_mode, VGA_AT10_FRESERVED & resmask);
	vga_wattr(VGA_ATC_OVERSCAN, self->vm_att_overscan);
	vga_wattr_res(VGA_ATC_PLANE_ENABLE, self->vm_att_plane_enable, VGA_AT12_FRESERVED & resmask);
	vga_wattr_res(VGA_ATC_PEL, self->vm_att_pel, VGA_AT13_FRESERVED & resmask);
	vga_wattr_res(VGA_ATC_COLOR_PAGE, self->vm_att_color_page, VGA_AT14_FRESERVED & resmask);
	for (i = 0; i < 16; ++i) {
		vga_wattr_res(VGA_ATC_PALETTE0 + i, self->vm_att_pal[i],
		              VGA_ATC_PALETTEn_FRESERVED & resmask);
	}
	vga_r(VGA_IS1_RC), vga_w(VGA_ATT_W, 0x20);
	vga_w(VGA_MIS_W, self->vm_mis);

	vga_wseq_res(VGA_SEQ_PLANE_WRITE, self->vm_seq_plane_write, VGA_SR02_FRESERVED & resmask);
	vga_wseq_res(VGA_SEQ_CHARACTER_MAP, self->vm_seq_character_map, VGA_SR03_FRESERVED & resmask);
	vga_wseq_res(VGA_SEQ_MEMORY_MODE, self->vm_seq_memory_mode, VGA_SR04_FRESERVED & resmask);

	vga_wgfx_res(VGA_GFX_SR_VALUE, self->vm_gfx_sr_value, VGA_GR00_FRESERVED & resmask);
	vga_wgfx_res(VGA_GFX_SR_ENABLE, self->vm_gfx_sr_enable, VGA_GR01_FRESERVED & resmask);
	vga_wgfx_res(VGA_GFX_COMPARE_VALUE, self->vm_gfx_compare_value, VGA_GR02_FRESERVED & resmask);
	vga_wgfx_res(VGA_GFX_DATA_ROTATE, self->vm_gfx_data_rotate, VGA_GR03_FRESERVED & resmask);
	vga_wgfx_res(VGA_GFX_PLANE_READ, self->vm_gfx_plane_read, VGA_GR04_FRESERVED & resmask);
	vga_wgfx_res(VGA_GFX_MODE, self->vm_gfx_mode, VGA_GR05_FRESERVED & resmask);
	vga_wgfx_res(VGA_GFX_MISC, self->vm_gfx_misc, VGA_GR06_FRESERVED & resmask);
	vga_wgfx_res(VGA_GFX_COMPARE_MASK, self->vm_gfx_compare_mask, VGA_GR07_FRESERVED & resmask);
	vga_wgfx(VGA_GFX_BIT_MASK, self->vm_gfx_bit_mask);

	/* Apply new graphics settings. */
	vga_wcrt(VGA_CRTC_H_TOTAL, self->vm_crt_h_total);
	vga_wcrt(VGA_CRTC_H_DISP, self->vm_crt_h_disp);
	vga_wcrt(VGA_CRTC_H_BLANK_START, self->vm_crt_h_blank_start);
	vga_wcrt(VGA_CRTC_H_BLANK_END, self->vm_crt_h_blank_end | (VGA_CR3_FALWAYS1 & resmask));
	vga_wcrt(VGA_CRTC_H_SYNC_START, self->vm_crt_h_sync_start);
	vga_wcrt(VGA_CRTC_H_SYNC_END, self->vm_crt_h_sync_end);
	vga_wcrt(VGA_CRTC_V_TOTAL, self->vm_crt_v_total);
	vga_wcrt(VGA_CRTC_OVERFLOW, self->vm_crt_overflow);
	vga_wcrt_res(VGA_CRTC_PRESET_ROW, self->vm_crt_preset_row, VGA_CR8_FRESERVED & resmask);
	vga_wcrt(VGA_CRTC_MAX_SCAN, self->vm_crt_max_scan);
	vga_wcrt_res(VGA_CRTC_CURSOR_START, self->vm_crt_cursor_start, VGA_CRA_FRESERVED & resmask);
	vga_wcrt_res(VGA_CRTC_CURSOR_END, self->vm_crt_cursor_end, VGA_CRB_FRESERVED & resmask);
	vga_wcrt(VGA_CRTC_START_HI, self->vm_crt_start_hi);
	vga_wcrt(VGA_CRTC_START_LO, self->vm_crt_start_lo);
	vga_wcrt(VGA_CRTC_CURSOR_HI, self->vm_crt_cursor_hi);
	vga_wcrt(VGA_CRTC_CURSOR_LO, self->vm_crt_cursor_lo);
	vga_wcrt(VGA_CRTC_V_SYNC_START, self->vm_crt_v_sync_start);
	vga_wcrt_res(VGA_CRTC_V_SYNC_END, self->vm_crt_v_sync_end, VGA_CR11_FRESERVED & resmask);
	vga_wcrt(VGA_CRTC_V_DISP_END, self->vm_crt_v_disp_end);
	vga_wcrt(VGA_CRTC_OFFSET, self->vm_crt_offset);
	vga_wcrt(VGA_CRTC_UNDERLINE, self->vm_crt_underline);
	vga_wcrt(VGA_CRTC_V_BLANK_START, self->vm_crt_v_blank_start);
	vga_wcrt_res(VGA_CRTC_V_BLANK_END, self->vm_crt_v_blank_end, VGA_CR16_FRESERVED & resmask);
	vga_wcrt_res(VGA_CRTC_MODE, self->vm_crt_mode, VGA_CR17_FRESERVED & resmask);
	vga_wcrt(VGA_CRTC_LINE_COMPARE, self->vm_crt_line_compare);

	/* Turn the screen back on. */
	vga_wseq(VGA_SEQ_RESET, 0x1);
	vga_wseq(VGA_SEQ_CLOCK_MODE, self->vm_seq_clock_mode);
	vga_wseq(VGA_SEQ_RESET, 0x3);
	return VGA_STATE_ERROR_SUCCESS;
}


struct vga_font_access_regs {
	u8 old_seq_plane_write;
	u8 old_seq_memory_mode;
	u8 old_gfx_plane_read;
	u8 old_gfx_mode;
	u8 old_gfx_misc;
};

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC begin_vga_font_access)(struct vga_font_access_regs *__restrict regs) {
	regs->old_seq_plane_write = vga_rseq(VGA_SEQ_PLANE_WRITE);
	regs->old_seq_memory_mode = vga_rseq(VGA_SEQ_MEMORY_MODE);
	regs->old_gfx_plane_read  = vga_rgfx(VGA_GFX_PLANE_READ);
	regs->old_gfx_mode        = vga_rgfx(VGA_GFX_MODE);
	regs->old_gfx_misc        = vga_rgfx(VGA_GFX_MISC);
	vga_wseq(VGA_SEQ_PLANE_WRITE, (regs->old_seq_plane_write & VGA_SR02_FRESERVED) | VGA_SR02_FPLANE(2));
	vga_wseq(VGA_SEQ_MEMORY_MODE, (regs->old_seq_memory_mode & VGA_SR04_FRESERVED) |
	                              (VGA_SR04_FEXT_MEM | VGA_SR04_FSEQ_MODE));
	vga_wgfx(VGA_GFX_PLANE_READ, (regs->old_gfx_plane_read & VGA_GR04_FRESERVED) | 0x02);
	vga_wgfx(VGA_GFX_MODE, (regs->old_gfx_mode & VGA_GR05_FRESERVED) | 0x00);
	vga_wgfx(VGA_GFX_MISC, (regs->old_gfx_misc & VGA_GR06_FRESERVED) |
	                       (VGA_GR06_FGRAPHICS_MODE | VGA_GR06_FMM_64K));
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC end_vga_font_access)(struct vga_font_access_regs *__restrict regs) {
	vga_wseq(VGA_SEQ_PLANE_WRITE, regs->old_seq_plane_write);
	vga_wseq(VGA_SEQ_MEMORY_MODE, regs->old_seq_memory_mode);
	vga_wgfx(VGA_GFX_PLANE_READ, regs->old_gfx_plane_read);
	vga_wgfx(VGA_GFX_MODE, regs->old_gfx_mode);
	vga_wgfx(VGA_GFX_MISC, regs->old_gfx_misc);
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC save_vga_font)(struct vga_font *__restrict self) {
	unsigned int i;
	struct vga_font_access_regs regs;
	u32 src = 0;
	begin_vga_font_access(&regs);
	for (i = 0; i < 256; ++i) {
		copyfromphys(&self->vf_blob[i], VGA_VRAM_BASE + src, 16);
		src += 32;
	}
	end_vga_font_access(&regs);
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC load_vga_font)(struct vga_font const *__restrict self) {
	unsigned int i;
	struct vga_font_access_regs regs;
	u32 src = 0;
	begin_vga_font_access(&regs);
	for (i = 0; i < 256; ++i) {
		copytophys(VGA_VRAM_BASE + src, &self->vf_blob[i], 16);
		src += 32;
	}
	end_vga_font_access(&regs);
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC save_vga_palette)(struct vga_color *__restrict pal,
                                    size_t num_bytes) {
	unsigned int i;
	vga_w(VGA_PEL_MSK, 0xff);
	vga_w(VGA_PEL_IR, 0x00);
	for (i = 0; i < num_bytes; ++i)
		((byte_t *)pal)[i] = vga_r(VGA_PEL_D);
	for (; i < 768; ++i)
		vga_r(VGA_PEL_D);
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC load_vga_palette)(struct vga_color const *__restrict pal,
                                    size_t num_bytes) {
	unsigned int i;
	vga_w(VGA_PEL_MSK, 0xff);
	vga_w(VGA_PEL_IW, 0x00);
	for (i = 0; i < num_bytes; ++i)
		vga_w(VGA_PEL_D, ((byte_t *)pal)[i]);
	for (; i < 768; ++i)
		vga_w(VGA_PEL_D, 0);
}

struct vga_text_access_regs {
	u8 old_seq_memory_mode;
	u8 old_gfx_plane_read;
	u8 old_gfx_mode;
	u8 old_gfx_misc;
};

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC begin_vga_text_access)(struct vga_text_access_regs *__restrict regs) {
	regs->old_seq_memory_mode = vga_rseq(VGA_SEQ_MEMORY_MODE);
	regs->old_gfx_plane_read  = vga_rgfx(VGA_GFX_PLANE_READ);
	regs->old_gfx_mode        = vga_rgfx(VGA_GFX_MODE);
	regs->old_gfx_misc        = vga_rgfx(VGA_GFX_MISC);

	/* Re-configure VGA so we can access what will eventually become text memory. */
	vga_wseq(VGA_SEQ_MEMORY_MODE,
	         (regs->old_seq_memory_mode & VGA_SR04_FRESERVED) |
	         VGA_SR04_FEXT_MEM);
	vga_wgfx(VGA_GFX_PLANE_READ,
	         (regs->old_gfx_plane_read & VGA_GR04_FRESERVED) |
	         VGA_GR04_READMAP(0));
	vga_wgfx(VGA_GFX_MODE,
	         (regs->old_gfx_mode & VGA_GR05_FRESERVED) |
	         VGA_GR05_FWRITEMODE_0 | VGA_GR05_FREADMODE_0 | VGA_GR05_FHOSTOE);
	vga_wgfx(VGA_GFX_MISC,
	         (regs->old_gfx_misc & VGA_GR06_FRESERVED) |
	         VGA_GR06_FTEXT_MODE | VGA_GR06_FCHAINOE | VGA_GR06_FMM_32K_HI);
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC end_vga_text_access)(struct vga_text_access_regs const *__restrict regs) {
	/* Restore VGA registers. */
	vga_wseq(VGA_SEQ_MEMORY_MODE, regs->old_seq_memory_mode);
	vga_wgfx(VGA_GFX_PLANE_READ, regs->old_gfx_plane_read);
	vga_wgfx(VGA_GFX_MODE, regs->old_gfx_mode);
	vga_wgfx(VGA_GFX_MISC, regs->old_gfx_misc);
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC save_vga_text)(u16 textbuf[80 * 25]) {
	struct vga_text_access_regs regs;
	begin_vga_text_access(&regs);

	/* Save old text memory. */
	copyfromphys(textbuf, VGA_VRAM_TEXT, 80 * 25 * 2);

	end_vga_text_access(&regs);
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC load_vga_text)(u16 const textbuf[80 * 25]) {
	struct vga_text_access_regs regs;
	begin_vga_text_access(&regs);

	/* Save old text memory. */
	copytophys(VGA_VRAM_TEXT, textbuf, 80 * 25 * 2);

	end_vga_text_access(&regs);
}

/* Base address where the virtual memory mapping for vm86 begins. */
#define VGA_VM86_SP  0x7c00 /* Grows down: Address for the initial SP-value for the BIOS */
#define VGA_VM86_BUF 0x7c00 /* Grows up:   Base address of variable-length BIOS data buffers */

#define VGA_VM86_BIOS_SIZE (0xfffff + 1)

typedef struct {
	vm86_state_t      vv_vm86;       /* The underlying vm86 state. */
	byte_t           *vv_biosbase;   /* Base address for where we've mapped the BIOS */
#ifdef __KERNEL__
	union {
		void             *vv_unmapcookie; /* [1..1][owned] Unmap cookie */
		pagedir_pushval_t vv_backup[VGA_VM86_BIOS_SIZE / PAGESIZE]; /* Backup of page directory mappings. */
	};
#endif /* __KERNEL__ */
} vga_vm86_state_t;

/* Return the virtual base address of the bios communication data buffer. */
#define vga_vm86_buffer(self, num_bytes) \
	((self)->vv_biosbase + VGA_VM86_BUF)


PRIVATE unsigned int
NOTHROW(CC vga_vm86_state_init)(vga_vm86_state_t *__restrict self) {
#ifdef __KERNEL__
	if (dbg_onstack()) {
		unsigned int i;
		byte_t *virt;
		physaddr_t phys;
		self->vv_biosbase = (byte_t *)KERNEL_CORE_BASE;
#ifdef ARCH_PAGEDIR_NEED_PERPARE_FOR_KERNELSPACE
		if (!pagedir_prepare(self->vv_biosbase, VGA_VM86_BIOS_SIZE))
			return VGA_STATE_ERROR_NOMEM;
#endif /* ARCH_PAGEDIR_NEED_PERPARE_FOR_KERNELSPACE */
		for (i = 0, virt = self->vv_biosbase, phys = 0;
		     i < VGA_VM86_BIOS_SIZE / PAGESIZE; ++i) {
			self->vv_backup[i] = pagedir_push_mapone(virt, phys,
			                                         PAGEDIR_PROT_READ |
			                                         PAGEDIR_PROT_WRITE);
			phys += PAGESIZE;
			virt += PAGESIZE;
		}
		pagedir_syncall();
	} else {
		if (!PREEMPTION_ENABLED())
			THROW(E_WOULDBLOCK_PREEMPTED);
		self->vv_unmapcookie = mman_unmap_kram_cookie_alloc();
		TRY {
			/* Use a regular memory mapping. */
			self->vv_biosbase = (byte_t *)mman_map(/* self:        */ &mman_kernel,
			                                       /* hint:        */ MHINT_GETADDR(KERNEL_MHINT_TEMPORARY),
			                                       /* num_bytes:   */ VGA_VM86_BIOS_SIZE,
			                                       /* prot:        */ PROT_READ | PROT_WRITE | PROT_SHARED,
			                                       /* flags:       */ MHINT_GETMODE(KERNEL_MHINT_TEMPORARY),
			                                       /* file:        */ &mfile_phys,
			                                       /* file_fspath: */ NULL,
			                                       /* file_fsname: */ NULL,
			                                       /* file_pos:    */ (pos_t)0);
		} EXCEPT {
			mman_unmap_kram_cookie_free(self->vv_unmapcookie);
			RETHROW();
		}
	}
#else /* __KERNEL__ */
	void *bios;
	bios = mmapphys(0, VGA_VM86_BIOS_SIZE);
	if (bios == MAP_FAILED)
		return VGA_STATE_ERROR_NOMEM;
	self->vv_biosbase = (byte_t *)bios;
#endif /* !__KERNEL__ */
	return VGA_STATE_ERROR_SUCCESS;
}

PRIVATE void
NOTHROW(CC vga_vm86_state_fini)(vga_vm86_state_t *__restrict self) {
#ifdef __KERNEL__
	if (dbg_onstack()) {
		unsigned int i;
		byte_t *virt;
		for (i = 0, virt = self->vv_biosbase;
		     i < VGA_VM86_BIOS_SIZE / PAGESIZE; ++i) {
			pagedir_pop_mapone(virt, self->vv_backup[i]);
			virt += PAGESIZE;
		}
	} else {
		mman_unmap_kram_and_kfree(self->vv_biosbase, VGA_VM86_BIOS_SIZE,
		                          self->vv_unmapcookie);
	}
#else /* __KERNEL__ */
	munmapphys(self->vv_biosbase, VGA_VM86_BIOS_SIZE);
#endif /* !__KERNEL__ */
}


PRIVATE ATTR_PURE WUNUSED NONNULL((1)) void *LIBVM86_TRANSLATE_CC
vm86_translate(vga_vm86_state_t *__restrict self, void *ptr) {
	return self->vv_biosbase + (uintptr_t)ptr;
}

PRIVATE int LIBVM86_CC
vm86_io(vm86_state_t *__restrict UNUSED(self),
        u16 port, unsigned int action,
        void *data) {
	int result = VM86_SUCCESS;
	switch (action) {

	case VM86_HANDLE_IO_INB:
		*(uint8_t *)data = inb((port_t)port);
		break;

	case VM86_HANDLE_IO_INW:
		*(uint16_t *)data = inw((port_t)port);
		break;

	case VM86_HANDLE_IO_INL:
		*(uint32_t *)data = inl((port_t)port);
		break;

	case VM86_HANDLE_IO_OUTB:
		outb((port_t)port, *(uint8_t const *)data);
		break;

	case VM86_HANDLE_IO_OUTW:
		outw((port_t)port, *(uint16_t const *)data);
		break;

	case VM86_HANDLE_IO_OUTL:
		outl((port_t)port, *(uint32_t const *)data);
		break;

	default:
		result = VM86_BADPORT;
		break;
	}
	return result;
}

PRIVATE bool
NOTHROW_KERNEL(CC bios_interrupt)(vga_vm86_state_t *__restrict self, u8 intno) {
	int error;
	self->vv_vm86.vr_trans       = (vm86_translate_t)&vm86_translate;
	self->vv_vm86.vr_io          = &vm86_io;
	self->vv_vm86.vr_intr        = NULL;
	self->vv_vm86.vr_regs.vr_esp = VGA_VM86_SP & 0xffff;
	self->vv_vm86.vr_regs.vr_ss  = (VGA_VM86_SP & 0xf0000) >> 4;
	self->vv_vm86.vr_regs.vr_eip = 0xffff;
	self->vv_vm86.vr_regs.vr_cs  = 0xffff;
	/* Generate a software interrupt */
	error = vm86_intr(&self->vv_vm86, intno);
	if (error != VM86_SUCCESS)
		return false;
	/* Execute VM86 code. */
	error = vm86_exec(&self->vv_vm86);
	return error == VM86_SUCCESS ||
	       error == VM86_STOPPED;
}


#ifdef __KERNEL__
#define BIOS_BUF_NULL                                physpage2addr(PHYSPAGE_INVALID)
#define BIOS_BUF_ALLOC(num_bytes)                    physpage2addr(page_malloc(CEILDIV(num_bytes, PAGESIZE)))
#define BIOS_BUF_FREE(buf, num_bytes)                page_free(physaddr2page(buf), CEILDIV(num_bytes, PAGESIZE))
#define BIOS_BUF_PREAD(buf, dst, num_bytes, offset)  copyfromphys(dst, (buf) + (offset), num_bytes)
#define BIOS_BUF_PWRITE(buf, src, num_bytes, offset) copytophys((buf) + (offset), src, num_bytes)
#else /* __KERNEL__ */
#define BIOS_BUF_NULL                                NULL
#define BIOS_BUF_ALLOC(num_bytes)                    ((__byte_t *)malloc(num_bytes))
#define BIOS_BUF_FREE(buf, num_bytes)                free(buf)
#define BIOS_BUF_PREAD(buf, dst, num_bytes, offset)  memcpy(dst, (__byte_t *)(buf) + (offset), num_bytes)
#define BIOS_BUF_PWRITE(buf, src, num_bytes, offset) memcpy((__byte_t *)(buf) + (offset), src, num_bytes)
#endif /* !__KERNEL__ */



/* s.a. http://www.ctyme.com/intr/rb-0277.htm */
PRIVATE NONNULL((1, 2)) bool
NOTHROW_KERNEL(CC bios_save_vesa_state)(vga_vm86_state_t *__restrict vs,
                                        struct vga_bios *__restrict self) {
	vga_bios_buf_t buf;
	size_t bufsize;
	byte_t *vmbuf;
	obzero(vs->vv_vm86.vr_regs);
	vs->vv_vm86.vr_regs.vr_ax = 0x4f04;
	vs->vv_vm86.vr_regs.vr_cx = 0xf;
	vs->vv_vm86.vr_regs.vr_dl = 0;
	/* get state buffer size (in %bx, as 64-byte blocks) */
	if (!bios_interrupt(vs, 0x10))
		goto fail;
	bufsize = vs->vv_vm86.vr_regs.vr_bx * 64;
	buf     = BIOS_BUF_ALLOC(bufsize);
	if (buf == BIOS_BUF_NULL)
		goto fail;
	obzero(vs->vv_vm86.vr_regs);
	vs->vv_vm86.vr_regs.vr_ax = 0x4f04;
	vs->vv_vm86.vr_regs.vr_cx = 0xf;
	vs->vv_vm86.vr_regs.vr_dl = 1;
	vmbuf                     = vga_vm86_buffer(vs, bufsize);
	vs->vv_vm86.vr_regs.vr_es = VM86_ADDRSEG(vmbuf);
	vs->vv_vm86.vr_regs.vr_bx = VM86_ADDROFF(vmbuf);
	/* load video state data. */
	if (!bios_interrupt(vs, 0x10))
		goto fail_buf;
	/* Copy BIOS buffer data into our own buffer. */
	BIOS_BUF_PWRITE(buf, vmbuf, bufsize, 0);
	/* Store the BIOS-buffer data blob */
	self->vb_vesa_statebuf = buf;
	self->vb_vesa_statesiz = bufsize;
	return true;
fail_buf:
	BIOS_BUF_FREE(buf, bufsize);
fail:
	return false;
}

PRIVATE NONNULL((1, 2)) bool
NOTHROW_KERNEL(CC bios_load_vesa_state)(vga_vm86_state_t *__restrict vs,
                                        struct vga_bios const *__restrict self) {
	byte_t *vmbuf;
	obzero(vs->vv_vm86.vr_regs);
	vs->vv_vm86.vr_regs.vr_ax = 0x4f04;
	vs->vv_vm86.vr_regs.vr_cx = 0xf;
	vs->vv_vm86.vr_regs.vr_dl = 2;
	vmbuf = vga_vm86_buffer(vs, self->vb_vesa_statesiz);
	/* Copy bios buffer memory into the VM area */
	BIOS_BUF_PREAD(self->vb_vesa_statebuf, vmbuf,
	               self->vb_vesa_statesiz, 0);
	vs->vv_vm86.vr_regs.vr_es = VM86_ADDRSEG(vmbuf);
	vs->vv_vm86.vr_regs.vr_bx = VM86_ADDROFF(vmbuf);
	/* Have the BIOS restore the video state. */
	return bios_interrupt(vs, 0x10);
}


/* s.a. http://www.ctyme.com/intr/rb-0276.htm */
PRIVATE NONNULL((1, 2)) bool
NOTHROW_KERNEL(CC bios_save_vesa_mode)(vga_vm86_state_t *__restrict vs,
                                       uint16_t *__restrict pmode) {
	obzero(vs->vv_vm86.vr_regs);
	vs->vv_vm86.vr_regs.vr_ax = 0x4f03;
	if (!bios_interrupt(vs, 0x10))
		goto fail;
	if (vs->vv_vm86.vr_regs.vr_ax != 0x4f)
		goto fail;
	*pmode = vs->vv_vm86.vr_regs.vr_bx;
	return true;
fail:
	return false;
}

/* s.a. http://www.ctyme.com/intr/rb-0275.htm */
PRIVATE NONNULL((1)) bool
NOTHROW_KERNEL(CC bios_load_vesa_mode)(vga_vm86_state_t *__restrict vs,
                                       uint16_t mode) {
	obzero(vs->vv_vm86.vr_regs);
	vs->vv_vm86.vr_regs.vr_ax = 0x4f02;
	vs->vv_vm86.vr_regs.vr_bx = mode;
	if (!bios_interrupt(vs, 0x10))
		goto fail;
	if (vs->vv_vm86.vr_regs.vr_ax != 0x4f)
		goto fail;
	return true;
fail:
	return false;
}

/* s.a. https://www.stanislavs.org/helppc/int_10-0.html */
PRIVATE NONNULL((1)) bool
NOTHROW_KERNEL(CC bios_load_vga_mode)(vga_vm86_state_t *__restrict vs,
                                      uint8_t mode) {
	u8 expected_al;
	obzero(vs->vv_vm86.vr_regs);
	vs->vv_vm86.vr_regs.vr_ah = 0x00;
	vs->vv_vm86.vr_regs.vr_al = mode;
	if (!bios_interrupt(vs, 0x10))
		goto fail;
	if (mode > 7)
		expected_al = 0x20;
	else if (mode == 6)
		expected_al = 0x3f;
	else {
		expected_al = 0x30;
	}
	if (vs->vv_vm86.vr_regs.vr_al != expected_al)
		goto fail;
	return true;
fail:
	return false;
}



PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC save_vga_bios)(struct vga_bios *__restrict self) {
	vga_vm86_state_t vs;
	if (vga_vm86_state_init(&vs) != VGA_STATE_ERROR_SUCCESS)
		return;
	if (!bios_save_vesa_state(&vs, self)) {
		if (bios_save_vesa_mode(&vs, &self->vb_vesa_mode))
			self->vb_features |= VGA_BIOS_FEAT_VESA_MODE;
	}
	vga_vm86_state_fini(&vs);
}

PRIVATE NONNULL((1)) void
NOTHROW_KERNEL(CC load_vga_bios)(struct vga_bios const *__restrict self) {
	vga_vm86_state_t vs;
	if (vga_vm86_state_init(&vs) != VGA_STATE_ERROR_SUCCESS)
		return;
	/* Restore the VESA state from a buffer */
	if (self->vb_vesa_statesiz)
		bios_load_vesa_state(&vs, self);
	/*  Restore VESA video mode by ID. */
	if (self->vb_features & VGA_BIOS_FEAT_VESA_MODE)
		bios_load_vesa_mode(&vs, self->vb_vesa_mode);
	vga_vm86_state_fini(&vs);
}

PRIVATE void
NOTHROW_KERNEL(CC text_vga_bios)(void) {
	vga_vm86_state_t vs;
	if (vga_vm86_state_init(&vs) != VGA_STATE_ERROR_SUCCESS)
		return;
	/* Try to switch to text mode, using VESA first, but
	 * with  regular, old VGA  interrupts as a fallback.
	 * NOTE: 0x8000 is the flag `MF_NOCLEARMEM' (name taken from seabios,
	 *       as  seen apart of QEMU's source tree). This flag (when set),
	 *       will prevent  display memory  from being  cleared (which  is
	 *       something we really want,  we want to manually  save/restore
	 *       only the part of video memory that we're actually using)
	 */
	if (!bios_load_vesa_mode(&vs, 0x8000 | 3)) {
		if (!bios_load_vesa_mode(&vs, 3))
			bios_load_vga_mode(&vs, 3);
	}
	vga_vm86_state_fini(&vs);
}








INTERN NONNULL((1)) unsigned int
NOTHROW_KERNEL(CC libvga_state_save)(struct vga_state *__restrict self) {
	unsigned int result;
	obzero(*self);
	result = save_vga_mode(&self->vs_mode);
	if unlikely(result != VGA_STATE_ERROR_SUCCESS)
		goto done;
	save_vga_palette(&self->vs_pal.vp_pal[0], sizeof(self->vs_pal.vp_pal));
	save_vga_font(&self->vs_font);
	save_vga_text(self->vs_text);
	/* Try to check if the BIOS can tell us anything we don't already know */
	save_vga_bios(&self->vs_bios);
done:
	return result;
}

INTERN NONNULL((1)) unsigned int
NOTHROW_KERNEL(CC libvga_state_load)(struct vga_state const *__restrict self) {
	unsigned int result;
	/* Use the BIOS to restore state-data that we're received from it specifically. */
	load_vga_bios(&self->vs_bios);
	load_vga_text(self->vs_text);
	load_vga_font(&self->vs_font);
	load_vga_palette(&self->vs_pal.vp_pal[0], sizeof(self->vs_pal.vp_pal));
	result = load_vga_mode(&self->vs_mode, 0x00);
	return result;
}

INTERN NONNULL((1)) void
NOTHROW_KERNEL(CC libvga_state_fini)(struct vga_state const *__restrict self) {
	(void)self;
	BIOS_BUF_FREE(self->vs_bios.vb_vesa_statebuf,
	              self->vs_bios.vb_vesa_statesiz);
}




PRIVATE struct vga_mode const textmode =
VGA_BIOTEXT80x25_MODE_INIT(VGA_PALINDX_CGA_ANSI_INIT);

PRIVATE struct vga_palette16 const textpal =
VGA_PALETTE_CGA_INIT;

#define CPVGA_ASCII_MIN 0x20 /* First ASCII-compatible ordinal */
#define CPVGA_ASCII_MAX 0x7E /* Last ASCII-compatible ordinal */

struct cpvga_encode_entry {
	char16_t cee_uni; /* Unicode ordinal */
	byte_t   cee_vga; /* VGA ordinal. */
	byte_t  _cee_pad; /* ... */
};


/* DISCLAIMER: parts of this font data have been generated from univga:
 * https://star.inp.nsk.su/~bolkhov/files/fonts/univga/ */
/*[[[deemon
// Somewhat based on cp437, but altered, including more box drawing
// stuff and less greek/math stuff. This is nothing official and this
// code page in particular cannot be found in official listings as it
// has been created for the sole purpose of existing as KOS's display
// VGA codepage
//
// There may or may not be an easteregg in here as well... ;)
local CPVGA = {
	0xFFFD, 0x263A, 0x263B, 0x2665, 0x2666, 0x2663, 0x2660, 0x2022,
	0x25D8, 0x25CB, 0x25D9, 0x2642, 0x2640, 0x266A, 0x266B, 0x263C,
	0x25BA, 0x25C4, 0x2195, 0x203C, 0x00B6, 0x00A7, 0x25AC, 0x21A8,
	0x2191, 0x2193, 0x2192, 0x2190, 0x221F, 0x2194, 0x25B2, 0x25BC,
	0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
	0x0028, 0x0029, 0x002A, 0x002B, 0x002C, 0x002D, 0x002E, 0x002F,
	0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
	0x0038, 0x0039, 0x003A, 0x003B, 0x003C, 0x003D, 0x003E, 0x003F,
	0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
	0x0048, 0x0049, 0x004A, 0x004B, 0x004C, 0x004D, 0x004E, 0x004F,
	0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
	0x0058, 0x0059, 0x005A, 0x005B, 0x005C, 0x005D, 0x005E, 0x005F,
	0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
	0x0068, 0x0069, 0x006A, 0x006B, 0x006C, 0x006D, 0x006E, 0x006F,
	0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
	0x0078, 0x0079, 0x007A, 0x007B, 0x007C, 0x007D, 0x007E, 0x2302,
	0x00C7, 0x00FC, 0x00E9, 0x00E2, 0x00E4, 0x00E0, 0x00E5, 0x00E7,
	0x00EA, 0x00EB, 0x00E8, 0x00EF, 0x00EE, 0x00EC, 0x00C4, 0x00C5,
	0x00C9, 0x00E6, 0x00C6, 0x00F4, 0x00F6, 0x00F2, 0x00FB, 0x00F9,
	0x00FF, 0x00D6, 0x00DC, 0x00A2, 0x00A3, 0x00A5, 0x20A7, 0x0192,
	0x00E1, 0x00ED, 0x00F3, 0x00FA, 0x00F1, 0x00D1, 0x00AA, 0x00BA,
	0x00BF, 0x2310, 0x00AC, 0x00BD, 0x00BC, 0x00A1, 0x00AB, 0x00BB,
	0x2591, 0x2592, 0x2593, 0x2502, 0x2524, 0x2561, 0x2562, 0x2556,
	0x2555, 0x2563, 0x2551, 0x2557, 0x255D, 0x255C, 0x255B, 0x2510,
	0x2514, 0x2534, 0x252C, 0x251C, 0x2500, 0x253C, 0x255E, 0x255F,
	0x255A, 0x2554, 0x2569, 0x2566, 0x2560, 0x2550, 0x256C, 0x2567,
	0x2568, 0x2564, 0x2565, 0x2559, 0x2558, 0x2552, 0x2553, 0x256B,
	0x256A, 0x2518, 0x250C, 0x2588, 0x2584, 0x258C, 0x2590, 0x2580,
	0x03B1, 0x00DF, 0x2596, 0x2597, 0x2598, 0x2599, 0x259A, 0x259B,
	0x259C, 0x259D, 0x259E, 0x259F, 0x221E, 0x03C6, 0x03B5, 0x2229,
	0x2261, 0x00B1, 0x2265, 0x2264, 0x2320, 0x2321, 0x00F7, 0x2248,
	0x00B0, 0x2219, 0x00B7, 0x221A, 0x207F, 0x00B2, 0x25A0, 0xE888,
};

import * from deemon;
import * from ...misc.libgen.libtlft.compiler;
import uniEscape from ..libiconv.iconvdata.util;

local tlft;
with (local fp = File.open("../../misc/fonts/tlft/uni_vga/u_vga16.bdf"))
	tlft = Dict(tlftParseBDF(fp).map);

// A couple of glyphs not ~really~ contained (the way we want them to be) in uni_vga
tlft[0x2588] = Bytes({ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }); // █
tlft[0x2584] = Bytes({ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }); // ▄
tlft[0x258C] = Bytes({ 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }); // ▌
tlft[0x2590] = Bytes({ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F }); // ▐
tlft[0x2580] = Bytes({ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }); // ▀
tlft[0x2596] = Bytes({ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }); // ▖
tlft[0x2597] = Bytes({ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F }); // ▗
tlft[0x2598] = Bytes({ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }); // ▘
tlft[0x2599] = Bytes({ 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }); // ▙
tlft[0x259A] = Bytes({ 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F }); // ▚
tlft[0x259B] = Bytes({ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }); // ▛
tlft[0x259C] = Bytes({ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F }); // ▜
tlft[0x259D] = Bytes({ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }); // ▝
tlft[0x259E] = Bytes({ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }); // ▞
tlft[0x259F] = Bytes({ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }); // ▟
tlft[0xE888] = Bytes({ 0x10, 0x28, 0x44, 0x92, 0xAA, 0xAA, 0xA2, 0x54, 0x8A, 0xAA, 0xAA, 0x92, 0x44, 0x28, 0x10, 0x00 }); // It's a secret...

print("PRIVATE struct vga_font const textfont = {{");
for (local i: [:256]) {
	local ord = CPVGA[i];
	local bytes = tlft.get(ord);
	if (bytes is none)
		bytes = Bytes(16, 0);
	if (#bytes != 16)
		bytes = bytes.resized(16);
	print("\t{ ", ", ".join(for (local b: bytes) "0x" + b.hex()[2:].upper().zfill(2)), " }, "
		"/" "* U+", ord.hex()[2:].upper().zfill(4), " ", uniEscape(ord), " *" "/");
}
print("}};");
local uniToCpVGA: {int: int} = Dict();
for (local i: [:256]) {
	if (i >= CPVGA_ASCII_MIN && i <= CPVGA_ASCII_MAX)
		assert CPVGA[i] == i;
	uniToCpVGA[CPVGA[i]] = i;
}

// Unicode -> vga w/ transliteration aliases
final local UNI_EQ_PAIRS: {(int, int)...} = {

	// Space characters
	(0x00A0, 0x0020), // 𝘕𝘉𝘚𝘗 → ␠
	(0x2007, 0x0020), //   → ␠

	// Pointing-triang characters
	(0x25B2, 0x25B4), (0x25B2, 0x25B3), // ▲ → ▴
	(0x25BA, 0x25B6), (0x25BA, 0x25B8), // ► → ▶, ▸
	(0x25BC, 0x25BE),                   // ▼ → ▾
	(0x25C4, 0x25C0), (0x25BA, 0x25C2), // ◄ → ◀, ◂
	(0x25A0, 0x25FC)
};

for (local a, b: UNI_EQ_PAIRS) {
	if (a !in uniToCpVGA && b in uniToCpVGA) {
		uniToCpVGA[a] = uniToCpVGA[b];
	} else if (b !in uniToCpVGA && a in uniToCpVGA) {
		uniToCpVGA[b] = uniToCpVGA[a];
	}
}

print("PRIVATE struct cpvga_encode_entry const cpvga_encode_db[] = {");
for (local uni: uniToCpVGA.keys.sorted()) {
	if (uni >= CPVGA_ASCII_MIN && uni <= CPVGA_ASCII_MAX)
		continue; // Handled explicitly
	assert uni <= 0xffff;
	print("	{ 0x", uni.hex()[2:].upper().zfill(4), ", 0x", uniToCpVGA[uni].hex()[2:].upper().zfill(2),
		" }, /" "* ", uniEscape(uni)),;
	print(" *" "/");
}
print("};");
]]]*/
PRIVATE struct vga_font const textfont = {{
	{ 0x00, 0x38, 0x7C, 0x7C, 0xC6, 0x92, 0xF2, 0xE6, 0xFE, 0xE6, 0x7C, 0x7C, 0x38, 0x00, 0x00, 0x00 }, /* U+FFFD � */
	{ 0x00, 0x00, 0x7E, 0x81, 0xA5, 0x81, 0x81, 0xA5, 0x99, 0x81, 0x81, 0x7E, 0x00, 0x00, 0x00, 0x00 }, /* U+263A ☺ */
	{ 0x00, 0x00, 0x7E, 0xFF, 0xDB, 0xFF, 0xFF, 0xDB, 0xE7, 0xFF, 0xFF, 0x7E, 0x00, 0x00, 0x00, 0x00 }, /* U+263B ☻ */
	{ 0x00, 0x00, 0x00, 0x00, 0x6C, 0xFE, 0xFE, 0xFE, 0xFE, 0x7C, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00 }, /* U+2665 ♥ */
	{ 0x00, 0x00, 0x00, 0x00, 0x10, 0x38, 0x7C, 0xFE, 0x7C, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2666 ♦ */
	{ 0x00, 0x00, 0x00, 0x18, 0x3C, 0x3C, 0xE7, 0xE7, 0xE7, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+2663 ♣ */
	{ 0x00, 0x00, 0x00, 0x18, 0x3C, 0x7E, 0xFF, 0xFF, 0x7E, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+2660 ♠ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x3C, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2022 • */
	{ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xC3, 0xC3, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }, /* U+25D8 ◘ */
	{ 0x00, 0x00, 0x3C, 0x42, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x42, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+25CB ○ */
	{ 0xFF, 0xFF, 0xC3, 0xBD, 0x7E, 0x7E, 0x7E, 0x7E, 0x7E, 0x7E, 0xBD, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF }, /* U+25D9 ◙ */
	{ 0x00, 0x00, 0x1E, 0x06, 0x0E, 0x1A, 0x78, 0xCC, 0xCC, 0xCC, 0xCC, 0x78, 0x00, 0x00, 0x00, 0x00 }, /* U+2642 ♂ */
	{ 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+2640 ♀ */
	{ 0x00, 0x00, 0x30, 0x3C, 0x3E, 0x32, 0x30, 0x30, 0x30, 0x70, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00 }, /* U+266A ♪ */
	{ 0x00, 0x00, 0x70, 0x7F, 0x6F, 0x63, 0x63, 0x63, 0x63, 0xE3, 0xE7, 0xC7, 0x06, 0x00, 0x00, 0x00 }, /* U+266B ♫ */
	{ 0x00, 0x00, 0x00, 0x10, 0x10, 0x54, 0x28, 0xC6, 0x28, 0x54, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00 }, /* U+263C ☼ */
	{ 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0xFE, 0xF8, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+25BA ► */
	{ 0x00, 0x00, 0x00, 0x00, 0x02, 0x0E, 0x3E, 0xFE, 0x3E, 0x0E, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+25C4 ◄ */
	{ 0x00, 0x00, 0x18, 0x3C, 0x7E, 0x18, 0x18, 0x18, 0x7E, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2195 ↕ */
	{ 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00 }, /* U+203C ‼ */
	{ 0x00, 0x00, 0x7F, 0xDB, 0xDB, 0xDB, 0x7B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x00, 0x00, 0x00, 0x00 }, /* U+00B6 ¶ */
	{ 0x00, 0x7C, 0xC6, 0x60, 0x38, 0x6C, 0xC6, 0xC6, 0x6C, 0x38, 0x0C, 0xC6, 0x7C, 0x00, 0x00, 0x00 }, /* U+00A7 § */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+25AC ▬ */
	{ 0x00, 0x00, 0x18, 0x3C, 0x7E, 0x18, 0x18, 0x18, 0x7E, 0x3C, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00 }, /* U+21A8 ↨ */
	{ 0x00, 0x00, 0x18, 0x3C, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+2191 ↑ */
	{ 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+2193 ↓ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x06, 0xFF, 0x06, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2192 → */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x60, 0xFF, 0x60, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2190 ← */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+221F ∟ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x66, 0xFF, 0x66, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2194 ↔ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x38, 0x38, 0x7C, 0x7C, 0xFE, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+25B2 ▲ */
	{ 0x00, 0x00, 0xFE, 0xFE, 0x7C, 0x7C, 0x38, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+25BC ▼ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+0020 ␠ */
	{ 0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+0021 ! */
	{ 0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+0022 " */
	{ 0x00, 0x00, 0x00, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00 }, /* U+0023 # */
	{ 0x18, 0x18, 0x7C, 0xC6, 0xC2, 0xC0, 0x7C, 0x06, 0x06, 0x86, 0xC6, 0x7C, 0x18, 0x18, 0x00, 0x00 }, /* U+0024 $ */
	{ 0x00, 0x00, 0x00, 0x00, 0xC2, 0xC6, 0x0C, 0x18, 0x30, 0x60, 0xC6, 0x86, 0x00, 0x00, 0x00, 0x00 }, /* U+0025 % */
	{ 0x00, 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+0026 & */
	{ 0x00, 0x30, 0x30, 0x30, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+0027 ' */
	{ 0x00, 0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00 }, /* U+0028 ( */
	{ 0x00, 0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00 }, /* U+0029 ) */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+002A * */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+002B + */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00 }, /* U+002C , */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+002D - */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+002E . */
	{ 0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00 }, /* U+002F / */
	{ 0x00, 0x00, 0x38, 0x6C, 0xC6, 0xC6, 0xD6, 0xD6, 0xC6, 0xC6, 0x6C, 0x38, 0x00, 0x00, 0x00, 0x00 }, /* U+0030 0 */
	{ 0x00, 0x00, 0x18, 0x38, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00 }, /* U+0031 1 */
	{ 0x00, 0x00, 0x7C, 0xC6, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+0032 2 */
	{ 0x00, 0x00, 0x7C, 0xC6, 0x06, 0x06, 0x3C, 0x06, 0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0033 3 */
	{ 0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00 }, /* U+0034 4 */
	{ 0x00, 0x00, 0xFE, 0xC0, 0xC0, 0xC0, 0xFC, 0x06, 0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0035 5 */
	{ 0x00, 0x00, 0x38, 0x60, 0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0036 6 */
	{ 0x00, 0x00, 0xFE, 0xC6, 0x06, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00 }, /* U+0037 7 */
	{ 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0038 8 */
	{ 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x06, 0x06, 0x0C, 0x78, 0x00, 0x00, 0x00, 0x00 }, /* U+0039 9 */
	{ 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+003A : */
	{ 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00 }, /* U+003B ; */
	{ 0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00 }, /* U+003C < */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+003D = */
	{ 0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00 }, /* U+003E > */
	{ 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x0C, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+003F ? */
	{ 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xDE, 0xDE, 0xDE, 0xDC, 0xC0, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0040 @ */
	{ 0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+0041 A */
	{ 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0x66, 0xFC, 0x00, 0x00, 0x00, 0x00 }, /* U+0042 B */
	{ 0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xC0, 0xC0, 0xC2, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+0043 C */
	{ 0x00, 0x00, 0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00, 0x00, 0x00, 0x00 }, /* U+0044 D */
	{ 0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68, 0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+0045 E */
	{ 0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68, 0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 }, /* U+0046 F */
	{ 0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xDE, 0xC6, 0xC6, 0x66, 0x3A, 0x00, 0x00, 0x00, 0x00 }, /* U+0047 G */
	{ 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+0048 H */
	{ 0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+0049 I */
	{ 0x00, 0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0xCC, 0x78, 0x00, 0x00, 0x00, 0x00 }, /* U+004A J */
	{ 0x00, 0x00, 0xE6, 0x66, 0x66, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 }, /* U+004B K */
	{ 0x00, 0x00, 0xF0, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+004C L */
	{ 0x00, 0x00, 0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+004D M */
	{ 0x00, 0x00, 0xC6, 0xE6, 0xF6, 0xFE, 0xDE, 0xCE, 0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+004E N */
	{ 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+004F O */
	{ 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 }, /* U+0050 P */
	{ 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xD6, 0xDE, 0x7C, 0x0C, 0x0E, 0x00, 0x00 }, /* U+0051 Q */
	{ 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 }, /* U+0052 R */
	{ 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x60, 0x38, 0x0C, 0x06, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0053 S */
	{ 0x00, 0x00, 0x7E, 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+0054 T */
	{ 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0055 U */
	{ 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00 }, /* U+0056 V */
	{ 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xD6, 0xD6, 0xD6, 0xFE, 0xEE, 0x6C, 0x00, 0x00, 0x00, 0x00 }, /* U+0057 W */
	{ 0x00, 0x00, 0xC6, 0xC6, 0x6C, 0x7C, 0x38, 0x38, 0x7C, 0x6C, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+0058 X */
	{ 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+0059 Y */
	{ 0x00, 0x00, 0xFE, 0xC6, 0x86, 0x0C, 0x18, 0x30, 0x60, 0xC2, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+005A Z */
	{ 0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+005B [ */
	{ 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0x70, 0x38, 0x1C, 0x0E, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00 }, /* U+005C \ */
	{ 0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+005D ] */
	{ 0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+005E ^ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00 }, /* U+005F _ */
	{ 0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+0060 ` */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+0061 a */
	{ 0x00, 0x00, 0xE0, 0x60, 0x60, 0x78, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0062 b */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0063 c */
	{ 0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x3C, 0x6C, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+0064 d */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0065 e */
	{ 0x00, 0x00, 0x38, 0x6C, 0x64, 0x60, 0xF0, 0x60, 0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 }, /* U+0066 f */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0xCC, 0x78, 0x00 }, /* U+0067 g */
	{ 0x00, 0x00, 0xE0, 0x60, 0x60, 0x6C, 0x76, 0x66, 0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 }, /* U+0068 h */
	{ 0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+0069 i */
	{ 0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00 }, /* U+006A j */
	{ 0x00, 0x00, 0xE0, 0x60, 0x60, 0x66, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 }, /* U+006B k */
	{ 0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+006C l */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xD6, 0xD6, 0xD6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+006D m */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00 }, /* U+006E n */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+006F o */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00 }, /* U+0070 p */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0x0C, 0x1E, 0x00 }, /* U+0071 q */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x76, 0x66, 0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 }, /* U+0072 r */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0x60, 0x38, 0x0C, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+0073 s */
	{ 0x00, 0x00, 0x10, 0x30, 0x30, 0xFC, 0x30, 0x30, 0x30, 0x30, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00 }, /* U+0074 t */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+0075 u */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+0076 v */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xD6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00, 0x00, 0x00, 0x00 }, /* U+0077 w */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0x6C, 0x38, 0x38, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+0078 x */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0xF8, 0x00 }, /* U+0079 y */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xCC, 0x18, 0x30, 0x60, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+007A z */
	{ 0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18, 0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00 }, /* U+007B { */
	{ 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+007C | */
	{ 0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00 }, /* U+007D } */
	{ 0x00, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+007E ~ */
	{ 0x00, 0x00, 0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2302 ⌂ */
	{ 0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xC0, 0xC0, 0xC2, 0x66, 0x3C, 0x18, 0x0C, 0x38, 0x00 }, /* U+00C7 Ç */
	{ 0x00, 0x00, 0xCC, 0xCC, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00FC ü */
	{ 0x00, 0x00, 0x0C, 0x18, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00E9 é */
	{ 0x00, 0x10, 0x38, 0x6C, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00E2 â */
	{ 0x00, 0x00, 0x6C, 0x6C, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00E4 ä */
	{ 0x00, 0x00, 0x60, 0x30, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00E0 à */
	{ 0x00, 0x38, 0x6C, 0x38, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00E5 å */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x7C, 0x18, 0x0C, 0x38, 0x00 }, /* U+00E7 ç */
	{ 0x00, 0x10, 0x38, 0x6C, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00EA ê */
	{ 0x00, 0x00, 0x6C, 0x6C, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00EB ë */
	{ 0x00, 0x00, 0x60, 0x30, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00E8 è */
	{ 0x00, 0x00, 0x66, 0x66, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+00EF ï */
	{ 0x00, 0x10, 0x38, 0x6C, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+00EE î */
	{ 0x00, 0x00, 0x30, 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+00EC ì */
	{ 0x6C, 0x6C, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+00C4 Ä */
	{ 0x38, 0x6C, 0x38, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+00C5 Å */
	{ 0x0C, 0x18, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+00C9 É */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xCC, 0x76, 0x36, 0x7E, 0xD8, 0xD8, 0x6E, 0x00, 0x00, 0x00, 0x00 }, /* U+00E6 æ */
	{ 0x00, 0x00, 0x3E, 0x6C, 0xCC, 0xCC, 0xFE, 0xCC, 0xCC, 0xCC, 0xCC, 0xCE, 0x00, 0x00, 0x00, 0x00 }, /* U+00C6 Æ */
	{ 0x00, 0x10, 0x38, 0x6C, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00F4 ô */
	{ 0x00, 0x00, 0x6C, 0x6C, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00F6 ö */
	{ 0x00, 0x00, 0x60, 0x30, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00F2 ò */
	{ 0x00, 0x10, 0x38, 0x6C, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00FB û */
	{ 0x00, 0x00, 0x60, 0x30, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00F9 ù */
	{ 0x00, 0x00, 0x6C, 0x6C, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0xF8, 0x00 }, /* U+00FF ÿ */
	{ 0x6C, 0x6C, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00D6 Ö */
	{ 0x6C, 0x6C, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00DC Ü */
	{ 0x00, 0x18, 0x18, 0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+00A2 ¢ */
	{ 0x00, 0x38, 0x6C, 0x64, 0x60, 0xF0, 0x60, 0x60, 0x60, 0x60, 0xE6, 0xFC, 0x00, 0x00, 0x00, 0x00 }, /* U+00A3 £ */
	{ 0x00, 0x00, 0x66, 0x66, 0x3C, 0x18, 0x7E, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+00A5 ¥ */
	{ 0x00, 0x00, 0xFC, 0x66, 0x66, 0x7C, 0x62, 0x66, 0x6F, 0x66, 0x66, 0xF3, 0x00, 0x00, 0x00, 0x00 }, /* U+20A7 ₧ */
	{ 0x00, 0x00, 0x1C, 0x36, 0x32, 0x30, 0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0xE0, 0x00 }, /* U+0192 ƒ */
	{ 0x00, 0x00, 0x18, 0x30, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00E1 á */
	{ 0x00, 0x00, 0x0C, 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /* U+00ED í */
	{ 0x00, 0x00, 0x0C, 0x18, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00F3 ó */
	{ 0x00, 0x00, 0x18, 0x30, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+00FA ú */
	{ 0x00, 0x00, 0x76, 0xDC, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00 }, /* U+00F1 ñ */
	{ 0x76, 0xDC, 0x00, 0xC6, 0xE6, 0xF6, 0xFE, 0xDE, 0xCE, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+00D1 Ñ */
	{ 0x00, 0x3C, 0x6C, 0x6C, 0x3E, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00AA ª */
	{ 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x00, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00BA º */
	{ 0x00, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30, 0x60, 0xC0, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+00BF ¿ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2310 ⌐ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00AC ¬ */
	{ 0x00, 0xC0, 0xC0, 0xC2, 0xC6, 0xCC, 0x18, 0x30, 0x60, 0xDC, 0x86, 0x0C, 0x18, 0x3E, 0x00, 0x00 }, /* U+00BD ½ */
	{ 0x00, 0xC0, 0xC0, 0xC2, 0xC6, 0xCC, 0x18, 0x30, 0x66, 0xCE, 0x9E, 0x3E, 0x06, 0x06, 0x00, 0x00 }, /* U+00BC ¼ */
	{ 0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+00A1 ¡ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x36, 0x6C, 0xD8, 0x6C, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00AB « */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0xD8, 0x6C, 0x36, 0x6C, 0xD8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00BB » */
	{ 0x11, 0x44, 0x11, 0x44, 0x11, 0x44, 0x11, 0x44, 0x11, 0x44, 0x11, 0x44, 0x11, 0x44, 0x11, 0x44 }, /* U+2591 ░ */
	{ 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA }, /* U+2592 ▒ */
	{ 0xDD, 0x77, 0xDD, 0x77, 0xDD, 0x77, 0xDD, 0x77, 0xDD, 0x77, 0xDD, 0x77, 0xDD, 0x77, 0xDD, 0x77 }, /* U+2593 ▓ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+2502 │ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+2524 ┤ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0x18, 0xF8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+2561 ╡ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0xF6, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2562 ╢ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2556 ╖ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x18, 0xF8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+2555 ╕ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0xF6, 0x06, 0xF6, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2563 ╣ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2551 ║ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x06, 0xF6, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2557 ╗ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0xF6, 0x06, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+255D ╝ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+255C ╜ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0x18, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+255B ╛ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+2510 ┐ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2514 └ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2534 ┴ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+252C ┬ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1F, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+251C ├ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2500 ─ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+253C ┼ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1F, 0x18, 0x1F, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+255E ╞ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+255F ╟ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x30, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+255A ╚ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x30, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2554 ╔ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0xF7, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2569 ╩ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xF7, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2566 ╦ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x30, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2560 ╠ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2550 ═ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0xF7, 0x00, 0xF7, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+256C ╬ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2567 ╧ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2568 ╨ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+2564 ╤ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2565 ╥ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2559 ╙ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1F, 0x18, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2558 ╘ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x18, 0x1F, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+2552 ╒ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+2553 ╓ */
	{ 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0xFF, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36 }, /* U+256B ╫ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0x18, 0xFF, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+256A ╪ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2518 ┘ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+250C ┌ */
	{ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }, /* U+2588 █ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }, /* U+2584 ▄ */
	{ 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }, /* U+258C ▌ */
	{ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F }, /* U+2590 ▐ */
	{ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2580 ▀ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 }, /* U+03B1 α */
	{ 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x6C, 0x66, 0x66, 0x66, 0x66, 0xEC, 0x00, 0x00, 0x00, 0x00 }, /* U+00DF ß */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }, /* U+2596 ▖ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F }, /* U+2597 ▗ */
	{ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }, /* U+2598 ▘ */
	{ 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }, /* U+2599 ▙ */
	{ 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F }, /* U+259A ▚ */
	{ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }, /* U+259B ▛ */
	{ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F }, /* U+259C ▜ */
	{ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+259D ▝ */
	{ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 }, /* U+259E ▞ */
	{ 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }, /* U+259F ▟ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xDB, 0xDB, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+221E ∞ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x6C, 0xD6, 0xD6, 0xD6, 0xD6, 0xD6, 0x7C, 0x10, 0x10, 0x10, 0x00 }, /* U+03C6 φ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0, 0x78, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 }, /* U+03B5 ε */
	{ 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 }, /* U+2229 ∩ */
	{ 0x00, 0x00, 0x00, 0x00, 0xFE, 0x00, 0x00, 0xFE, 0x00, 0x00, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2261 ≡ */
	{ 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00B1 ± */
	{ 0x00, 0x00, 0x00, 0x00, 0xE0, 0x38, 0x0E, 0x38, 0xE0, 0x00, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2265 ≥ */
	{ 0x00, 0x00, 0x00, 0x00, 0x0E, 0x38, 0xE0, 0x38, 0x0E, 0x00, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2264 ≤ */
	{ 0x00, 0x00, 0x0E, 0x1B, 0x1B, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18 }, /* U+2320 ⌠ */
	{ 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xD8, 0xD8, 0xD8, 0x70, 0x00, 0x00, 0x00, 0x00 }, /* U+2321 ⌡ */
	{ 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x7E, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00F7 ÷ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xDC, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2248 ≈ */
	{ 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00B0 ° */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x3C, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+2219 ∙ */
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00B7 · */
	{ 0x00, 0x00, 0x03, 0x03, 0x06, 0x06, 0x06, 0x0C, 0xCC, 0x6C, 0x38, 0x18, 0x00, 0x00, 0x00, 0x00 }, /* U+221A √ */
	{ 0x00, 0x00, 0xB0, 0xD8, 0xD8, 0xD8, 0xD8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+207F ⁿ */
	{ 0x00, 0x70, 0xD8, 0x30, 0x60, 0xC8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /* U+00B2 ² */
	{ 0x00, 0x00, 0x00, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0x00, 0x00, 0x00, 0x00 }, /* U+25A0 ■ */
	{ 0x10, 0x28, 0x44, 0x92, 0xAA, 0xAA, 0xA2, 0x54, 0x8A, 0xAA, 0xAA, 0x92, 0x44, 0x28, 0x10, 0x00 }, /* U+E888  */
}};
PRIVATE struct cpvga_encode_entry const cpvga_encode_db[] = {
	{ 0x00A0, 0x20 }, /* 𝘕𝘉𝘚𝘗 */
	{ 0x00A1, 0xAD }, /* ¡ */
	{ 0x00A2, 0x9B }, /* ¢ */
	{ 0x00A3, 0x9C }, /* £ */
	{ 0x00A5, 0x9D }, /* ¥ */
	{ 0x00A7, 0x15 }, /* § */
	{ 0x00AA, 0xA6 }, /* ª */
	{ 0x00AB, 0xAE }, /* « */
	{ 0x00AC, 0xAA }, /* ¬ */
	{ 0x00B0, 0xF8 }, /* ° */
	{ 0x00B1, 0xF1 }, /* ± */
	{ 0x00B2, 0xFD }, /* ² */
	{ 0x00B6, 0x14 }, /* ¶ */
	{ 0x00B7, 0xFA }, /* · */
	{ 0x00BA, 0xA7 }, /* º */
	{ 0x00BB, 0xAF }, /* » */
	{ 0x00BC, 0xAC }, /* ¼ */
	{ 0x00BD, 0xAB }, /* ½ */
	{ 0x00BF, 0xA8 }, /* ¿ */
	{ 0x00C4, 0x8E }, /* Ä */
	{ 0x00C5, 0x8F }, /* Å */
	{ 0x00C6, 0x92 }, /* Æ */
	{ 0x00C7, 0x80 }, /* Ç */
	{ 0x00C9, 0x90 }, /* É */
	{ 0x00D1, 0xA5 }, /* Ñ */
	{ 0x00D6, 0x99 }, /* Ö */
	{ 0x00DC, 0x9A }, /* Ü */
	{ 0x00DF, 0xE1 }, /* ß */
	{ 0x00E0, 0x85 }, /* à */
	{ 0x00E1, 0xA0 }, /* á */
	{ 0x00E2, 0x83 }, /* â */
	{ 0x00E4, 0x84 }, /* ä */
	{ 0x00E5, 0x86 }, /* å */
	{ 0x00E6, 0x91 }, /* æ */
	{ 0x00E7, 0x87 }, /* ç */
	{ 0x00E8, 0x8A }, /* è */
	{ 0x00E9, 0x82 }, /* é */
	{ 0x00EA, 0x88 }, /* ê */
	{ 0x00EB, 0x89 }, /* ë */
	{ 0x00EC, 0x8D }, /* ì */
	{ 0x00ED, 0xA1 }, /* í */
	{ 0x00EE, 0x8C }, /* î */
	{ 0x00EF, 0x8B }, /* ï */
	{ 0x00F1, 0xA4 }, /* ñ */
	{ 0x00F2, 0x95 }, /* ò */
	{ 0x00F3, 0xA2 }, /* ó */
	{ 0x00F4, 0x93 }, /* ô */
	{ 0x00F6, 0x94 }, /* ö */
	{ 0x00F7, 0xF6 }, /* ÷ */
	{ 0x00F9, 0x97 }, /* ù */
	{ 0x00FA, 0xA3 }, /* ú */
	{ 0x00FB, 0x96 }, /* û */
	{ 0x00FC, 0x81 }, /* ü */
	{ 0x00FF, 0x98 }, /* ÿ */
	{ 0x0192, 0x9F }, /* ƒ */
	{ 0x03B1, 0xE0 }, /* α */
	{ 0x03B5, 0xEE }, /* ε */
	{ 0x03C6, 0xED }, /* φ */
	{ 0x2007, 0x20 }, /*   */
	{ 0x2022, 0x07 }, /* • */
	{ 0x203C, 0x13 }, /* ‼ */
	{ 0x207F, 0xFC }, /* ⁿ */
	{ 0x20A7, 0x9E }, /* ₧ */
	{ 0x2190, 0x1B }, /* ← */
	{ 0x2191, 0x18 }, /* ↑ */
	{ 0x2192, 0x1A }, /* → */
	{ 0x2193, 0x19 }, /* ↓ */
	{ 0x2194, 0x1D }, /* ↔ */
	{ 0x2195, 0x12 }, /* ↕ */
	{ 0x21A8, 0x17 }, /* ↨ */
	{ 0x2219, 0xF9 }, /* ∙ */
	{ 0x221A, 0xFB }, /* √ */
	{ 0x221E, 0xEC }, /* ∞ */
	{ 0x221F, 0x1C }, /* ∟ */
	{ 0x2229, 0xEF }, /* ∩ */
	{ 0x2248, 0xF7 }, /* ≈ */
	{ 0x2261, 0xF0 }, /* ≡ */
	{ 0x2264, 0xF3 }, /* ≤ */
	{ 0x2265, 0xF2 }, /* ≥ */
	{ 0x2302, 0x7F }, /* ⌂ */
	{ 0x2310, 0xA9 }, /* ⌐ */
	{ 0x2320, 0xF4 }, /* ⌠ */
	{ 0x2321, 0xF5 }, /* ⌡ */
	{ 0x2500, 0xC4 }, /* ─ */
	{ 0x2502, 0xB3 }, /* │ */
	{ 0x250C, 0xDA }, /* ┌ */
	{ 0x2510, 0xBF }, /* ┐ */
	{ 0x2514, 0xC0 }, /* └ */
	{ 0x2518, 0xD9 }, /* ┘ */
	{ 0x251C, 0xC3 }, /* ├ */
	{ 0x2524, 0xB4 }, /* ┤ */
	{ 0x252C, 0xC2 }, /* ┬ */
	{ 0x2534, 0xC1 }, /* ┴ */
	{ 0x253C, 0xC5 }, /* ┼ */
	{ 0x2550, 0xCD }, /* ═ */
	{ 0x2551, 0xBA }, /* ║ */
	{ 0x2552, 0xD5 }, /* ╒ */
	{ 0x2553, 0xD6 }, /* ╓ */
	{ 0x2554, 0xC9 }, /* ╔ */
	{ 0x2555, 0xB8 }, /* ╕ */
	{ 0x2556, 0xB7 }, /* ╖ */
	{ 0x2557, 0xBB }, /* ╗ */
	{ 0x2558, 0xD4 }, /* ╘ */
	{ 0x2559, 0xD3 }, /* ╙ */
	{ 0x255A, 0xC8 }, /* ╚ */
	{ 0x255B, 0xBE }, /* ╛ */
	{ 0x255C, 0xBD }, /* ╜ */
	{ 0x255D, 0xBC }, /* ╝ */
	{ 0x255E, 0xC6 }, /* ╞ */
	{ 0x255F, 0xC7 }, /* ╟ */
	{ 0x2560, 0xCC }, /* ╠ */
	{ 0x2561, 0xB5 }, /* ╡ */
	{ 0x2562, 0xB6 }, /* ╢ */
	{ 0x2563, 0xB9 }, /* ╣ */
	{ 0x2564, 0xD1 }, /* ╤ */
	{ 0x2565, 0xD2 }, /* ╥ */
	{ 0x2566, 0xCB }, /* ╦ */
	{ 0x2567, 0xCF }, /* ╧ */
	{ 0x2568, 0xD0 }, /* ╨ */
	{ 0x2569, 0xCA }, /* ╩ */
	{ 0x256A, 0xD8 }, /* ╪ */
	{ 0x256B, 0xD7 }, /* ╫ */
	{ 0x256C, 0xCE }, /* ╬ */
	{ 0x2580, 0xDF }, /* ▀ */
	{ 0x2584, 0xDC }, /* ▄ */
	{ 0x2588, 0xDB }, /* █ */
	{ 0x258C, 0xDD }, /* ▌ */
	{ 0x2590, 0xDE }, /* ▐ */
	{ 0x2591, 0xB0 }, /* ░ */
	{ 0x2592, 0xB1 }, /* ▒ */
	{ 0x2593, 0xB2 }, /* ▓ */
	{ 0x2596, 0xE2 }, /* ▖ */
	{ 0x2597, 0xE3 }, /* ▗ */
	{ 0x2598, 0xE4 }, /* ▘ */
	{ 0x2599, 0xE5 }, /* ▙ */
	{ 0x259A, 0xE6 }, /* ▚ */
	{ 0x259B, 0xE7 }, /* ▛ */
	{ 0x259C, 0xE8 }, /* ▜ */
	{ 0x259D, 0xE9 }, /* ▝ */
	{ 0x259E, 0xEA }, /* ▞ */
	{ 0x259F, 0xEB }, /* ▟ */
	{ 0x25A0, 0xFE }, /* ■ */
	{ 0x25AC, 0x16 }, /* ▬ */
	{ 0x25B2, 0x1E }, /* ▲ */
	{ 0x25B3, 0x1E }, /* △ */
	{ 0x25B4, 0x1E }, /* ▴ */
	{ 0x25B6, 0x10 }, /* ▶ */
	{ 0x25B8, 0x10 }, /* ▸ */
	{ 0x25BA, 0x10 }, /* ► */
	{ 0x25BC, 0x1F }, /* ▼ */
	{ 0x25BE, 0x1F }, /* ▾ */
	{ 0x25C0, 0x11 }, /* ◀ */
	{ 0x25C2, 0x10 }, /* ◂ */
	{ 0x25C4, 0x11 }, /* ◄ */
	{ 0x25CB, 0x09 }, /* ○ */
	{ 0x25D8, 0x08 }, /* ◘ */
	{ 0x25D9, 0x0A }, /* ◙ */
	{ 0x25FC, 0xFE }, /* ◼ */
	{ 0x263A, 0x01 }, /* ☺ */
	{ 0x263B, 0x02 }, /* ☻ */
	{ 0x263C, 0x0F }, /* ☼ */
	{ 0x2640, 0x0C }, /* ♀ */
	{ 0x2642, 0x0B }, /* ♂ */
	{ 0x2660, 0x06 }, /* ♠ */
	{ 0x2663, 0x05 }, /* ♣ */
	{ 0x2665, 0x03 }, /* ♥ */
	{ 0x2666, 0x04 }, /* ♦ */
	{ 0x266A, 0x0D }, /* ♪ */
	{ 0x266B, 0x0E }, /* ♫ */
	{ 0xE888, 0xFF }, /*  */
	{ 0xFFFD, 0x00 }, /* � */
};
/*[[[end]]]*/


INTERN unsigned int
NOTHROW_KERNEL(CC libvga_state_text)(void) {
	unsigned int result;
	/* Try using the BIOS to switch to 80x25 text mode.
	 * If user-space also used the BIOS to switch to extended graphics mode,
	 * the bios might know more than we do about switching back to text-mode */
	text_vga_bios();

	result = load_vga_mode(&textmode, 0xff);
	if unlikely(result != VGA_STATE_ERROR_SUCCESS)
		goto done;
	load_vga_palette(textpal.vp_pal, sizeof(textpal.vp_pal));
	load_vga_font(&textfont);
done:
	return result;
}


/* Encode a given unicode character and return the VGA codepage ordinal with
 * which that character should be represented. As a fallback for glyphs that
 * don't appear in the VGA codepage, the ordinal of a replacement  character
 * will be returned instead.
 * This function also does some internal transliteration in order to provide
 * more support  for  similar-looking  unicode characters  (e.g.  ►  and  ▶) */
INTERN ATTR_CONST byte_t NOTHROW(CC libvga_state_encode)(char32_t ch) {
	size_t lo, hi;
	if likely(ch >= CPVGA_ASCII_MIN && ch <= CPVGA_ASCII_MAX)
		return (byte_t)ch;
	/* Binary search through `cpvga_encode_db' */
	lo = 0;
	hi = COMPILER_LENOF(cpvga_encode_db);
	while (lo < hi) {
		size_t i;
		i = (lo + hi) / 2;
		if (ch < cpvga_encode_db[i].cee_uni) {
			hi = i;
		} else if (ch > cpvga_encode_db[i].cee_uni) {
			lo = i + 1;
		} else {
			return cpvga_encode_db[i].cee_vga;
		}
	}

	/* "full width" characters (we're VGA, so all characters are equal-sized, or "full width"):
	 * ！＂＃＄％＆＇（）＊＋，－．／０１２３４５６７８９：；＜＝＞？＠ＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯ
	 * ＰＱＲＳＴＵＶＷＸＹＺ［＼］＾＿｀ａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚ｛｜｝～ */
	if (ch >= 0xFF01 && ch <= 0xFF5E)
		return 0x0021 + (ch - 0xFF01);

	return 0x00; /* U+FFFD: � */
}



DEFINE_PUBLIC_ALIAS(vga_state_save, libvga_state_save);
DEFINE_PUBLIC_ALIAS(vga_state_load, libvga_state_load);
DEFINE_PUBLIC_ALIAS(vga_state_fini, libvga_state_fini);
DEFINE_PUBLIC_ALIAS(vga_state_text, libvga_state_text);
DEFINE_PUBLIC_ALIAS(vga_state_encode, libvga_state_encode);

DECL_END

#endif /* !GUARD_LIBVGASTATE_VGASTATE_C */
